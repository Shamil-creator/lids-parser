# Структура проекта "Лидген-комбайн"

```
lids parser/
├── main.py                      # Точка входа, запуск админ-бота и менеджера userbot'ов
├── config.py                    # Конфигурация системы (токены, задержки, пути)
├── requirements.txt             # Зависимости Python
├── README.md                    # Документация проекта
├── .env.example                 # Пример файла с переменными окружения
├── .gitignore                   # Игнорируемые файлы для Git
│
├── database/                    # Работа с базой данных
│   ├── __init__.py
│   └── models.py               # Модели БД (SQLite), все таблицы и методы работы
│
├── handlers/                   # Обработчики для админ-бота
│   ├── __init__.py
│   └── admin_panel.py          # Админ-панель (Aiogram 3.x)
│                                 - Команда /admin251219750
│                                 - Меню статистики, каналов, ключевых слов
│                                 - Управление аккаунтами (FSM для добавления)
│
├── services/                    # Бизнес-логика системы
│   ├── __init__.py
│   ├── userbot_manager.py      # Менеджер пула userbot'ов (Pyrogram)
│   │                            - Динамический запуск/остановка клиентов
│   │                            - Основной цикл работы воркеров
│   │                            - Обработка входящих сообщений
│   ├── parser.py               # Парсер каналов
│   │                            - Поиск сообщений с ключевыми словами
│   │                            - Фильтрация по стоп-словам
│   └── messenger.py            # Сервис рассылки и обработки ответов
│                                 - Отправка первого сообщения
│                                 - Обработка входящих сообщений (поиск телефонов)
│                                 - Пересылка лидов в канал менеджеров
│                                 - Дожимающие сообщения через 4 часа
│
├── sessions/                    # Папка для хранения сессий Pyrogram
│   └── *.session               # Файлы сессий (автоматически создаются)
│
└── bot_database.db             # База данных SQLite (создается автоматически)
```

## Основные компоненты

### 1. Control Bot (Админка)
- **Библиотека:** Aiogram 3.x
- **Вход:** Команда `/admin251219750`
- **Функционал:**
  - Статистика лидов (общая и по каналам)
  - Управление каналами для парсинга
  - Управление ключевыми словами и стоп-словами
  - Управление шаблонами сообщений
  - Добавление/удаление аккаунтов (FSM-сценарий с авторизацией)

### 2. Userbots (Воркеры)
- **Библиотека:** Pyrogram
- **Архитектура:** Multi-client (каждый аккаунт в отдельном процессе)
- **Логика работы:**
  1. Парсинг каналов из БД
  2. Фильтрация сообщений (ключевые слова + стоп-слова)
  3. Отправка первого сообщения автору поста
  4. Обработка ответов (поиск телефонов)
  5. Пересылка лидов в канал менеджеров
  6. Дожимающие сообщения через 4 часа

### 3. База данных (SQLite)
**Таблицы:**
- `admins` - администраторы системы
- `accounts` - аккаунты userbot'ов (session_name, phone, api_id, api_hash, status)
- `channels` - каналы для парсинга
- `keywords` - ключевые слова
- `stopwords` - стоп-слова
- `message_templates` - шаблоны сообщений
- `processed_users` - обработанные пользователи (чтобы не писать дважды)
- `leads` - детальная информация о лидах
- `leads_stats` - статистика лидов

## Особенности реализации

1. **Агрессивная работа:** Минимальные задержки, быстрая обработка ошибок
2. **Отказоустойчивость:** Если аккаунт забанен/FloodWait - помечается в БД, система продолжает работать
3. **24/7 работа:** Система не останавливается при ошибках одного аккаунта
4. **Хранение API credentials:** Сохраняются в БД при добавлении аккаунта
5. **Автоматическая авторизация:** FSM-сценарий для добавления аккаунта прямо в чате с ботом


